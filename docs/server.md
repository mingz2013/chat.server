客户端和服务器通信

客户端请求,服务器响应

客户端发送心跳包,来请求服务器响应

服务器不主动向客户端推送消息,只通过心跳包推送消息

跟web开发就一样了

只需要底层连接保证连接

上层一样

消息存储在数据库,当要推送消息的时候,从数据库拿出来推出去


如果接受消息的用户在线,直接推送,如果不在线,存储到数据库,等待心跳包


就是客户端需要给服务器回应retcode，服务器也需要给客户端回应retcode

packet 只定义发送的包,回应包很简单,很固定,

心跳包机制
客户端发送,或者服务器发送,逻辑层判断是否存活
心跳包一般来说都是在逻辑层发送空的echo包来实现的。
下一个定时器，在一定时间间隔下发送一个空包给客户端，
然后客户端反馈一个同样的空包回来，服务器如果在一定时间内收不到客户端发送过来的反馈包，那就只有认定说掉线了。

心跳检测步骤：
1客户端每隔一个时间间隔发生一个探测包给服务器
2客户端发包时启动一个超时定时器
3服务器端接收到检测包，应该回应一个包
4如果客户机收到服务器的应答包，则说明服务器正常，删除超时定时器
5如果客户端的超时定时器超时，依然没有收到应答包，则说明服务器挂了
转自：http://blog.sina.com.cn/s/blog_a459dcf5010153m5.html

那么怎以样才算网络空闭呢？
这里要用到消息队列一个数组， 
你每次需要向后台发送数据的时候都把数据封装成一个发送任务，放在你的消息队列里，
你有一个线程，设每秒运行一次，每次运行时扫描队列是否有任务，如果有则发送到后台，
没有则表示网络空闲，你的心跳计时器还发启动，计时到20秒时，插一个心跳任务到你的队列






客户端间隔发送心跳包数据给服务器, 服务器在一定时间内发回心跳包响应,对比超时时间,
如果超过设定的超时时间, 则认为当前与服务器的websocket链接已经断开,关闭当前websocket链接,善后处理
例如重新链接,或者弹出提示

服务器端,在超过一定时间内没有收到客户端发来的心跳包,则认为该客户端已经掉线,关闭链接,收回资源

这里参考了大神的思路：[微信心跳方案][1]

服务器是怎么处理心跳包的？

如果客户端心跳间隔是固定的, 那么服务器在连接闲置超过这个时间还没收到心跳时, 可以认为对方掉线, 关闭连接. 如果客户端心跳会动态改变, 如上节提到的微信心跳方案, 应当设置一个最大值, 超过这个最大值才认为对方掉线. 还有一种情况就是服务器通过TCP连接主动给客户端发消息出现写超时, 可以直接认为对方掉线。通过这样的的方式，就可以判断用户是否在线或者离线。

作者：应云超
链接：https://zhuanlan.zhihu.com/p/22515351
来源：知乎
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。






engine.io 不支持断线重连,看看socket.io, 或者其他人为engino写的reconnect库

换用socket.io 解决自动重连,心跳包问题